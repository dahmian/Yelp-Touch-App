<html> 
<head> 
<title>Yelp for Touch</title> 
<link rel="stylesheet" type="text/css" href="styles.css"></link>
</head> 
<body>
	<form id="search">
    <h1>Yelp Touch Interface</h1>
		<input name="term" placeholder="search term" autofocus required list="commonTerms"/>
    <datalist id="commonTerms">
      <option value="sushi"/>
      <option value="ramen"/>
    </datalist>
		<input name="location" placeholder="location" required />
		<button id="submit">Search</button>
	</form>
	<div id="searchResults"></div>
</body>
<script type="text/javascript" src="jquery.js"></script> 
<script type="text/javascript" src="oauth.js"></script>
<script type="text/javascript" src="sha1.js"></script>
<script type="text/javascript" src="mustache.js"></script>
<script type="text/javascript" src="config.js"></script>
<script>
	document.getElementById("search").onsubmit = search;

	function search(eventObj) {
		var terms = eventObj.srcElement.querySelector("[name=term]").value;
		var near = eventObj.srcElement.querySelector("[name=location]").value;


		var accessor = {
		  consumerSecret: auth.consumerSecret,
		  tokenSecret: auth.accessTokenSecret
		};

		parameters = [];
		parameters.push(['term', terms]);
		parameters.push(['location', near]);
		parameters.push(['callback', 'cb']);
		parameters.push(['oauth_consumer_key', auth.consumerKey]);
		parameters.push(['oauth_consumer_secret', auth.consumerSecret]);
		parameters.push(['oauth_token', auth.accessToken]);
		parameters.push(['oauth_signature_method', 'HMAC-SHA1']);

		var message = { 
		  'action': 'http://api.yelp.com/v2/search',
		  'method': 'GET',
		  'parameters': parameters 
		};

		OAuth.setTimestampAndNonce(message);
		OAuth.SignatureMethod.sign(message, accessor);

		var parameterMap = OAuth.getParameterMap(message.parameters);
		parameterMap.oauth_signature = OAuth.percentEncode(parameterMap.oauth_signature)

		$.ajax({
		  'url': message.action,
		  'data': parameterMap,
		  'cache': true,
		  'dataType': 'jsonp',
		  'jsonpCallback': 'cb',
      'success': displayResults
		});
		return false;
	}

  function displayResults(data, textStats, XMLHttpRequest) {
    console.log(data);
    data.businesses.sort(sortHighestToLowest);
    data.businesses.filter(removeClosedStores);
    var compiledTemplate = Mustache.compile("{{#businesses}}<p>{{rating}} <a href={{url}}>{{name}}</a></p>{{/businesses}}");
    var templateOutput = compiledTemplate(data);
    document.querySelector("#searchResults").innerHTML = templateOutput;

    function sortHighestToLowest(a, b) {
      if (a.rating < b.rating) {
        return 1;
      } else if (a.rating > b.rating) {
        return -1
      } else {
        return 0
      }
    }

    function removeClosedStores(element, index, array) {
      if (element.is_closed === false) {
        return element.is_closed;
      }
    }
  }
</script>

</html>
