<html> 
<head> 
<title>Yelp for Touch</title> 
<link rel="stylesheet" type="text/css" href="styles.css"></link>
</head> 
<body>
  <h1>Yelp Touch Interface</h1>
  <div class="row">
    <button class="searchButton">Sushi</button>
    <button class="searchButton">Pizza</button>
    <button class="searchButton">Burger</button>
  </div>
  <div class="row">
    <button id="otherButton" class="searchButton">Other</button>
  </div>
	<div id="searchResults"></div>
</body>
<script type="text/javascript" src="jquery.js"></script> 
<script type="text/javascript" src="oauth.js"></script>
<script type="text/javascript" src="sha1.js"></script>
<script type="text/javascript" src="mustache.js"></script>
<script type="text/javascript" src="config.js"></script>
<script>
  addEventHandlers();

  function addEventHandlers() {
    var buttons = document.querySelectorAll(".searchButton");
    for(var i = 0; i < buttons.length; i++) {
      var term = buttons[i].innerHTML;
      buttons[i].onclick = search.bind(null, term, displayResults);
    }

    document.getElementById("otherButton").onclick = displaySearchOption;
  }

  function displaySearchOption() {
    this.innerHTML = "Other<form><input autofocus></input><button>Search</button></form>";
    this.querySelector("form").onsubmit = function() {
      var term = this.querySelector("input").value;
      search(term, displayResults);
      return false;
    }
  }

  navigator.geolocation.getCurrentPosition(getPosition);

  function getPosition(position) {
    return {
      latitude: position.coords.latitude,
      longitude: position.coords.longitude
    }
  }

	function search(terms, callback) {

    alert(terms);
		var accessor = {
		  consumerSecret: auth.consumerSecret,
		  tokenSecret: auth.accessTokenSecret
		};

		parameters = [];
		parameters.push(['term', terms]);
		parameters.push(['ll', "33.777010600000004,-107.9136227"]);
		parameters.push(['callback', 'cb']);
		parameters.push(['oauth_consumer_key', auth.consumerKey]);
		parameters.push(['oauth_consumer_secret', auth.consumerSecret]);
		parameters.push(['oauth_token', auth.accessToken]);
		parameters.push(['oauth_signature_method', 'HMAC-SHA1']);

		var message = { 
		  'action': 'http://api.yelp.com/v2/search',
		  'method': 'GET',
		  'parameters': parameters 
		};

		OAuth.setTimestampAndNonce(message);
		OAuth.SignatureMethod.sign(message, accessor);

		var parameterMap = OAuth.getParameterMap(message.parameters);
		parameterMap.oauth_signature = OAuth.percentEncode(parameterMap.oauth_signature)

		$.ajax({
		  'url': message.action,
		  'data': parameterMap,
		  'cache': true,
		  'dataType': 'jsonp',
		  'jsonpCallback': 'cb',
      'success': callback 
		});
		return false;
	}

  function displayResults(data, textStats, XMLHttpRequest) {
    console.log(data);
    var formattedResults = format(data);
    var renderedResults = render(formattedResults);
    document.querySelector("#searchResults").innerHTML = renderedResults;

    function format(data) {
      data.businesses.sort(sortHighestToLowest);
      data.businesses.filter(removeClosedStores);
      data.businesses.forEach(convertDistanceMetersToMiles);
      return data;

      function sortHighestToLowest(a, b) {
        if (a.rating < b.rating) {
          return 1;
        } else if (a.rating > b.rating) {
          return -1
        } else {
          return 0
        }
      }

      function removeClosedStores(element, index, array) {
        if (element.is_closed === false) {
          return element.is_closed;
        }
      }

      function convertDistanceMetersToMiles(element, index, array) {
        var miles = element.distance * 0.000621371;
        var roundedMiles = Math.round(miles * 10) /10;
        var formattedString = roundedMiles + " miles";
        element.distance = formattedString;
      }
    }

    function render(data) {
      var compiledTemplate = Mustache.compile("{{#businesses}}<p>{{rating}} <a href={{url}}>{{name}}</a> {{distance}}</p>{{/businesses}}");
      return compiledTemplate(data);
    }
  }
</script>

</html>
